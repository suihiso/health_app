{% extends "base.html" %}

{% block title %}Прогнозирование данных{% endblock %}

{% block content %}
<h2>Прогнозирование данных</h2>
<hr>

<!-- Вывод сообщений об ошибках -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="mt-2 mb-3">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}" role="alert">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Единая форма для загрузки файлов и прогнозирования -->
<form method="POST" enctype="multipart/form-data" id="prediction-form">
    <div class="row">
        <!-- Левая колонка: Загрузка модели -->
        <div class="col-md-6 border-end">
            <h4>Загрузка обученной модели прогнозирования</h4>
            <p>Загрузите файл с обученной моделью в формате JOBLIB:</p>

            <div class="input-group mb-3">
                <input type="file" class="form-control" name="model_file" id="model_file" accept=".joblib">
            </div>

            <!-- Блок для предупреждений о незагруженной модели -->
            {% if model_error %}
            <div class="alert alert-danger mt-2" id="model-error">
                {{ model_error }}
            </div>
            {% endif %}

            <div class="card bg-light mb-3">
                <div class="card-body">
                    <p class="card-text">
                        <strong>Обученная модель</strong> для прогнозирования данных — это математическая модель,
                        которая
                        прошла процесс обучения на основе исторических данных и теперь способна делать предсказания о
                        новых,
                        ранее не встречавшихся данных.
                    </p>
                    <p class="card-text mb-0">
                        У вас нет обученной модели? Обучите модель <a href="{{ url_for('training_models') }}"
                            class="fw-bold">ЗДЕСЬ</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Правая колонка: Загрузка данных -->
        <div class="col-md-6">
            <h4>Загрузка инференсных данных</h4>
            <p>Загрузите файл с инференсными данными в форматах CSV или Excel:</p>

            <div class="input-group mb-3">
                <input type="file" class="form-control" name="test_data_file" id="test_data_file"
                    accept=".csv, .xls, .xlsx">
            </div>

            <!-- Блок для предупреждений о незагруженных данных -->
            {% if data_error %}
            <div class="alert alert-danger mt-2" id="data-error">
                {{ data_error }}
            </div>
            {% endif %}

            <div class="card bg-light mb-3">
                <div class="card-body">
                    <p class="card-text">
                        <strong>Инференсные данные</strong> (inference data) — это новые данные, которые
                        используются после обучения модели для получения новых прогнозов или выводов.
                    </p>
                    <p class="card-text mb-0">
                        <strong>ВАЖНО:</strong> инференсные данные должны содержать те же признаки, на которых обучалась
                        модель.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Кнопка для запуска прогнозирования -->
    <div class="text-center my-4">
        <button type="submit" class="btn btn-primary btn-lg" name="submit_action" value="predict">
            Сделать прогноз
        </button>
    </div>
</form>

<hr>

<!-- Блок с результатами прогнозирования -->
{% if predictions is defined %}
<div id="predictions-results" class="mt-4">
    <h3 class="text-center mb-3">Результаты прогнозирования</h3>

    <!-- Краткая сводка результатов -->
    <div class="alert alert-info py-2">
        <div class="d-flex justify-content-between flex-wrap">
            <span><strong>Обработано прогнозов:</strong> {{ prediction_count }}</span>
            <span><strong>Среднее значение прогноза:</strong> {{ prediction_mean }}</span>
            <span><strong>Минимум:</strong> {{ prediction_min }}</span>
            <span><strong>Максимум:</strong> {{ prediction_max }}</span>
        </div>
    </div>

    <!-- Липкое меню с разделами -->
    <div class="anchor-nav mb-4">
        <a href="#predictions-table" class="btn btn-outline-primary btn-sm">Таблица прогнозов</a>
        <a href="#predictions-stats" class="btn btn-outline-primary btn-sm">Статистика</a>
        <a href="#predictions-hist" class="btn btn-outline-primary btn-sm">Гистограмма распределений</a>
    </div>

    <!-- Таблица прогнозов -->
    <div id="predictions-table">
        <h4>Таблица прогнозов</h4>

        <!-- Пагинация сверху -->
        {% if total_pages > 1 %}
        <nav aria-label="Навигация по таблице прогнозов" class="mb-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('forecasting', page=current_page-1) if current_page > 1 else '#' }}">Предыдущая</a>
                </li>

                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == current_page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('forecasting', page=p) }}">{{ p }}</a>
                </li>
                {% endfor %}

                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('forecasting', page=current_page+1) if current_page < total_pages else '#' }}">Следующая</a>
                </li>
            </ul>
        </nav>
        {% endif %}

        <!-- Таблица -->
        <div class="table-responsive">
            {{ predictions_table | safe }}
        </div>

        <!-- Пагинация снизу -->
        {% if total_pages > 1 %}
        <nav aria-label="Навигация по таблице прогнозов" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('forecasting', page=current_page-1) if current_page > 1 else '#' }}">Предыдущая</a>
                </li>

                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == current_page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('forecasting', page=p) }}">{{ p }}</a>
                </li>
                {% endfor %}

                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('forecasting', page=current_page+1) if current_page < total_pages else '#' }}">Следующая</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>

    <hr>

    <!-- Статистика -->
    <div id="predictions-stats">
        <h4>Статистика</h4>
        <div class="table-responsive">
            {{ stats_table | safe }}
        </div>
    </div>

    <hr>

    <!-- Гистограмма распределений -->
    <div id="predictions-hist">
        <h4>Гистограмма распределений</h4>
        <div class="text-center">
            <img src="data:image/png;base64,{{ hist_image }}" class="img-fluid border"
                alt="Гистограмма распределения прогнозов">
        </div>
    </div>
</div>
{% endif %}

{% endblock %}